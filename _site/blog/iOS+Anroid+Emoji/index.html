<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>iOS和Android的Emoji表情同步方案 &#8211; Jeason</title>
<meta name="description" content="">
<meta name="keywords" content="IOS Developer">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS和Android的Emoji表情同步方案">
<meta property="og:description" content="">
<meta property="og:url" content="http://localhost:4000/blog/iOS%2BAnroid%2BEmoji">
<meta property="og:site_name" content="Jeason">
<meta property="og:image" content="http://localhost:4000/images/emoji.jpg">





<link rel="canonical" href="http://localhost:4000/blog/iOS%2BAnroid%2BEmoji">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Jeason Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/style.css" />

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <i class="icon-remove-sign"></i>
        <ul class="search-results post-list"></ul><!-- /.search-results -->
    </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->




<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  
<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom"  style="background-image: url(http://localhost:4000/images/emoji.jpg)" itemscope itemtype="http://schema.org/Organization">


    <div class="inner">
        <div class="container">
            <a class="brand" href="http://localhost:4000" role="banner" itemprop="url">

                <img itemprop="logo" src="http://localhost:4000/images/logo.png" alt="Jeason Logo" />

            <h1 class="blog-title light" itemprop="name">
                Jeason
            </h1>
                
            </a>
        </div>
    </div>
    
    
    <div class="decor-wrapper">
        <svg id="header-decor" class="decor bottom" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

            <path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>

            <path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path>

            <path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>

            <path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>

        </svg>
    </div>
    
</header>
<div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
    <div class="container">
        <div class="row">
            <article class="post col-md-8 col-md-offset-2 hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
            
            
            
                
            
             
             
                    <header class="post-header entry-header">
                        
                        <h1 class="post-title text-center hyper lighter bordered-bottom entry-title" itemprop="headline">iOS和Android的Emoji表情同步方案</h1>
                        
                        <div class="post-info text-center small">
                            <span class="entry-date date published updated"><time datetime="2014-08-24T00:00:00+08:00" class="post-time" itemprop="datePublished">24 Aug 2014</time><span>
                            in <span class="post-tags"><a href="http://localhost:4000/categories/index.html#blog" data-toggle="tooltip" title="Other posts from the Blog category" rel="tag">Blog</a></span>
                        </div>
                    </header>
                    <div class="post-body bordered-bottom" itemprop="description">
                        
                        <p>最近在做一个聊天的应用，有一个问题就是iOS跟Android的Emoji字符不对应导致显示不正常。因为iOS这部分是先做的，所以便让负责安卓的同学想办法兼容iOS的编码表，不过安卓的同学想尽办法也没办法搞到Apple Color Emoji的编码表，不过他却找到了有几百张Emoji表情的图片，后来经过整理剩下180张是完整的放在项目里的，图片下载在<a href="http://pan.baidu.com/s/1o6qMC22">这里</a>.于是，我就利用这些图片来想办法跟现有的项目兼容。</p>

<h2 id="section">之前的情况</h2>
<p>iOS之前的Emoji部分，是用了<a href="https://gist.github.com/izhuxin/bbb2a4895f150e0648f1">这个文件夹里的类</a>来产生所有的Emoji表情的unicode字符的，主要是做了一个映射和一定的排序和筛选，来使这些表情不会太杂乱。内部的实现可以说是看起来比较复杂但是思路很简单的，就不做详细赘述了.安卓的同学说安卓有一个可以图文混排的View，叫做<a href="http://developer.android.com/reference/android/widget/EditText.html">EditText</a>的.</p>

<p>于是，安卓的同学就希望我将iOS这边也是改成图文混排的方式，发送表情的时候就只是发送图片的名字，然后我们再约定每个图片的名字以一个特殊的字符开始并以一个特殊的字符结束，不过想到现有的方案要推倒重来实在不妥，而且用图片很难保证在每个分辨率的手机上都能有很好的效果。似乎手Q就是用的这种方案，因为我在看安卓手机发来的emoji表情的时候有很明显的锯齿…</p>

<p>另外在服务器方面，之前iOS发送Emoji表情跟发送文字是一起的，即是以unicode的方式发送和存储的。</p>

<h2 id="section-1">我的方案</h2>
<p>我想到安卓的同学之所以没办法搞到Apple Color Emoji的编码表，是因为这个字体只在苹果系上才有，所以不如我来搞定那个编码表吧，把Emoji的unicode编码和图片对应起来，然后在每次Model传数据给View的时候，将图片名解析成unicode编码，然后在保存至Model的时候将unicode编码转换成图片名就好了，这样子只需要设置字体的大小就能控制emoji表情的大小了，而且以前的代码几乎不用修改。</p>

<p>方法很简单，但就是花时间，所以才特地整理了这篇文章可以省大家的力气。我先是将所有的emoji Code和Emoji表情打印到<a href="https://gist.github.com/732bc2b5f7dca13fe630">文件</a>里，然后跟图片文件进行比对，整理出了他们的<a href="https://gist.github.com/b812ab0bf87093907e26">映射表</a>.</p>

<p>然后就需要跟服务器和安卓的同学约定好Emoji开始的字符和结束的字符就好了，我们的定义如下:</p>

<div class="highlight"><pre><code class="c"><span class="cp">#define EmojiBegin                      0x02</span>
<span class="cp">#define EmojiEnd                        0x03</span>
</code></pre></div>

<p>接下来就是解析工作了，还是很简单的，我是写了一个category来完成这些工作，代码如下:</p>

<p>NSString+Emoji.h</p>

<pre><code class="language-objectivec">
//
//  NSString+Emoji.h
//  EmojiAdapter
//
//  Created by Jeason on 14-8-11.
//  Copyright (c) 2014年 EmojiAdapter. All rights reserved.
//

#import &lt;Foundation/Foundation.h&gt;

@interface NSString (Emoji)

/**
 *  Encode a string contains emoji string to a string contains emoji filename.
 *  Just encode each substring to filename, if it hs no associating filename, it will return nil.
 *  @return the encoded string
 */
- (NSString *)encodeString;

/**
 *  Decode the string contains file names to String contains emoji string.
 *
 *  @return the result string
 */
- (NSString *)decodeString;

/**
 *  Generate the encode dictionary to encode an emoji string to filename
 *
 *  @return the encode dictionary
 */
+ (NSDictionary *)encodeDictionary;

@end


</code></pre>

<p>NSString+Emoji.m</p>

<pre><code class="language-objectivec">
//
//  NSString+Emoji.m
//  EmojiAdapter
//
//  Created by Jeason on 14-8-11.
//  Copyright (c) 2014年 EmojiAdapter. All rights reserved.
//

#import "NSString+Emoji.h"
#import "Emoji.h"

#define EmojiBegin 0x02
#define EmojiEnd   0x03

@implementation NSString (Emoji)

-(NSString *)decodeString {
    __block BOOL isEmojiBegin = false;
    __block NSString *emojiFileName = @"";      //temp var to store the file name
    __block NSMutableString *result = [NSMutableString stringWithString:@""];
    
    [self enumerateSubstringsInRange:NSMakeRange(0, [self length])
                               options:NSStringEnumerationByComposedCharacterSequences //setperate as composed character
                            usingBlock:^(NSString *substring, NSRange substringRange, NSRange enclosingRange, BOOL *stop) {
                                const char *utf8Str = [substring UTF8String];
                                char aChar = [substring characterAtIndex:0]; //a unicode substr's length is 2
                                if ( aChar == EmojiBegin &amp;&amp; strlen(utf8Str) == 1 ) { //卧槽，句号的unicode编码刚好第一个字符就是0x02
                                    isEmojiBegin = YES;
                                } else if ( aChar == EmojiEnd &amp;&amp; strlen(utf8Str) == 1 ) {   //if it is in end
                                    isEmojiBegin = NO;
                                    NSString *emoji = [emojiFileName decodeEmojiString];    //decode the filename
                                    if ( emoji != nil ) {   //if decode succ
                                        [result appendString:emoji];    //add to result
                                    }
                                    emojiFileName = @"";    //clear file name
                                } else {
                                    if ( isEmojiBegin ) {   //the next substring is part of filename
                                        emojiFileName = [emojiFileName stringByAppendingString:substring];
                                    } else {    //the next substring is the normal string
                                        [result appendString:substring];
                                    }
                                }
                            }];
    
    return [NSString stringWithString:result];
}

/**
 *  Decode a single file name to emoji string
 *
 *  @return the decode emoji string
 */
- (NSString *)decodeEmojiString {
    NSString *plistName;
    if ( [self length] &gt;= 3 ) { //if the filename is valid
        if ( [self characterAtIndex:0] == 'f' ) {
            if ( [self characterAtIndex:1] == 'l' ) {
                //flower
                plistName = @"EmojiFlower";
            } else {
                //face
                plistName = @"EmojiFace";
            }
        } else if ( [self characterAtIndex:0] == 's' ) {
            if ( [self characterAtIndex:1] == 't' ) {
                //status
                plistName = @"EmojiStatus";
            } else {
                //symbol
                plistName = @"EmojiSymbol";
            }
        } else if ( [self characterAtIndex:0] == 'm' ) {
            //meal
            plistName = @"EmojiMeal";
        }
        NSString *filePath = [[NSBundle mainBundle] pathForResource:plistName ofType:@"plist"];
        NSDictionary *decodeDict = [[NSDictionary alloc] initWithContentsOfFile:filePath];//read the plist file
        NSInteger emojiCode = [[decodeDict objectForKey:self] intValue];
        return [Emoji emojiWithCode:emojiCode];
    } else {
        return @"";
    }
}

+ (NSDictionary *)encodeDictionary {
    NSArray *plistNames = @[@"ToEmojiFace", @"ToEmojiFlower", @"ToEmojiStatus", @"ToEmojiSymbol", @"ToEmojiMeal"];
    NSMutableDictionary *toEmojiDict = [NSMutableDictionary dictionary];
    for (NSString *pName in plistNames) {
        NSString *filePath = [[NSBundle mainBundle] pathForResource:pName ofType:@"plist"];
        NSDictionary *dict = [[NSDictionary alloc] initWithContentsOfFile:filePath];
        [toEmojiDict addEntriesFromDictionary:dict];
    }
    return toEmojiDict;
}

- (NSString *)encodeString {
    
    NSDictionary *toEmojiDict = [NSString encodeDictionary];
    
    __block NSMutableString *result = [NSMutableString stringWithString:@""];
    [self enumerateSubstringsInRange:NSMakeRange(0, [self length])
                             options:NSStringEnumerationByComposedCharacterSequences
                          usingBlock:^(NSString *substring, NSRange substringRange, NSRange enclosingRange, BOOL *stop) {
                              NSString *encodeStr = toEmojiDict[substring];
                              encodeStr = encodeStr == nil ? substring : [encodeStr encodeEmojiString];
                              [result appendString:encodeStr];
                          }];
    
    return [NSString stringWithString:result];
}

/**
 *  Encode emoji string with a prefix and a postfix
 *
 *  @return the encoded emoji string
 */
-(NSString *)encodeEmojiString {
    return [NSString stringWithFormat:@"%c%@%c",EmojiBegin, self, EmojiEnd];
}

@end

</code></pre>

<p>这样子，就可以在需要写数据库和发送网络的时候调用
<code>
someChatMsg = [someChatMsg encodeString];
</code></p>

<p>然后在想要显示UI的部分调用
<code>
someChatMsg = [someChatMsg decodeString];
</code></p>

<p>而且，在Emoji.m里为每个Emoji查找一次看有没有对应的文件名来筛选出可以在iOS跟安卓通用的Emoji表情啦！完整的项目Demo在<a href="https://github.com/izhuxin/EmojiAdapter">这里</a></p>

<h2 id="section-2">补充一句</h2>
<p>为什么要筛选只有180个表情呢，因为发现不论是手Q还是微信还是自带的Emoji键盘，它都是每行有7个表情，一页有3行，最后一个是删除键，这样子180个表情就有180 ／ （7*3-1） ＝ 9页啦，所以180个已经是非常足够了的，太多页也会让用户失去耐心~</p>

                        <br>
                    <span class="entry-tags">
                    <p>
                        <i class="icon-tags"></i>&nbsp;Tagged with IOS Developer
                    </p>
                    </span>
                    </div>
        </div>
                    <footer class="post-footer entry-meta">
                        
                        <div class="post-author text-center">                       
	        <img src="http://localhost:4000/images/headphoto.JPG" alt="Jeason George's photo" itemprop="image" class="post-avatar img-circle img-responsive"/>    
	    <h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person">By <span itemprop="name" class="fn"><a href="http://localhost:4000/about" title="About Jeason George" itemprop="url">Jeason George</a></span></h4>
	    <p>创作，只是为了让我不会对浮躁的社会无话可说</p>
</div> 
                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    </footer>
            </article>
    </div>
</div>


<footer id="footer"  class="blog-background overlay text-center align-middle animated from-top" style="background-image: url(http://localhost:4000/images/emoji.jpg)" >


    <div class="inner">
        <div class="container">

            <ul class="social-icons">
            
            
            
            
            <li>
                <a href="http://stackoverflow.com/users/3993969/jeason" data-toggle="tooltip" title="Jeason George on StackOverflow" target="_blank">
                    <i class="icon-stackexchange"></i>
                </a>
            </li>
            <li>
                <a href="http://weibo.com/u/2966878797" data-toggle="tooltip" title="Jeason George on Sina Weibo" target = "_blank">
                    <i class="icon-weibo"></i>
                </a>
            </li>
            
            
            <li>
                <a href="http://github.com/izhuxin" data-toggle="tooltip" title="Jeason George on Github" target="_blank">
                    <i class="icon-github"></i>
                </a>
            </li>
            <li><a href="http://localhost:4000/feed.xml" data-toggle="tooltip" title="Atom/RSS feed" target="_blank">
                    <i class="icon-rss"></i>
                </a>
            </li>

        </ul>
            <p class="copy-text">
                <a href="http://localhost:4000/about/">Jeason George</a> &copy; 2014 &bull; All rights reserved.
            </p>

            <ul class="menu-items">
            
            <li>
                
                    <a href="http://localhost:4000/"><i class="icon-home"></i>首页</a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/blog"><i class="icon-bug"></i>技术博客</a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/diary"><i class="icon-book"></i>杂谈日志</a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/album"><i class="icon-camera"></i>游记相册</a>&nbsp;&bull;
                
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/about"><i class="icon-user"></i>关于</a>&nbsp;&bull;
                
            </li>
            
            <li class="dosearch"><i class="icon-search"></i> 站内搜索</li>
        </ul>
        </div>
    </div>
    
        <div class="decor-wrapper">
            <svg id="footer-decor" class="decor top" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">

                <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
                <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

                <path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
                <path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>

                <path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
                <path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path>

                <path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>

                <path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>

            </svg>
        </div>
    
</footer>


    
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>
    <script type="text/javascript" src="http://localhost:4000/assets/js/waypoints.min.js"></script>
    <script type="text/javascript" src="http://localhost:4000/assets/js/script.js"></script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://localhost:4000/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-48042789-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'Jeason'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> 
</body>
</html>